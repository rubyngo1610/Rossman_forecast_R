---
title: "Rossmann_2"
author: "Ngoc Ngo & Nhi Huynh"
date: "7/14/2020"
output: html_document
---
DATA CLEANSING

Load packages
```{r}
library(ggplot2)
library(sqldf)
library(dplyr)
```

Import data
```{r}
train <- read.csv("train.csv")
```

Show the structure of train data
```{r}
str(train)
```

Change the data type of "Date" from "char" to "date"
```{r}
train$Date <- as.Date(as.character(train$Date))
```

Factorize categorical data fields in train data
```{r}
train$DayOfWeek <- as.factor(as.integer(train$DayOfWeek))
train$StateHoliday <- as.factor(as.character(train$StateHoliday))
train$Open <- as.factor(as.character(train$Open))
train$Promo <- as.factor(as.character(train$Promo))
train$SchoolHoliday <- as.factor(as.character(train$SchoolHoliday))
```

Check if there's any NA
```{r}
table (complete.cases (train))
```
no NULL values found

```{r}
summary(train)
```

Assign column names for store data
```{r}
colNames <- c ("Store", "StoreType",	"Assortment",	"CompetitionDistance",	
              "CompetitionOpenSinceMonth", "CompetitionOpenSinceYear",
              "PromoContinuation",	"PromoParticipationSinceWeek",	
              "PromoParticipationSinceYear", "PromoInterval")
```

Read store data
```{r}
store <- read.table ("store.csv", header = TRUE, sep = ",",
                       strip.white = TRUE, col.names = colNames,
                       na.strings = "?", stringsAsFactors = TRUE)
```

Show the structure of the store data
```{r}
str (store)
```

Identify NA cases
```{r}
table (complete.cases (store))
```

Replace the NAs in Competition Distance by its median
```{r}
store$CompetitionDistance[is.na(store$CompetitionDistance)] <- median(store$CompetitionDistance, na.rm=TRUE)
```

Replace the remaining NA's by 0
```{r}
store[is.na(store)] <- 0
```

Table summary
```{r}
summary(store)
```

Join table using dplyr
```{r}
train_store <- merge(train, store, by = "Store")
```

EXPLORATION
For graph to show full number
```{r}
options("scipen" = 10)
```

Sales in relation to Store
```{r}
MeanSalesPerStore <- vector(mode = "numeric",length = 1115)
for (i in 1:1115) {
  MeanSalesPerStore[i] <- mean(train_store$Sales[train_store$Store==i])
}
match(max(MeanSalesPerStore),MeanSalesPerStore) 
match(min(MeanSalesPerStore),MeanSalesPerStore) 
```
Store 262 has the max mean sales
Store 307 has the min mean sales

```{r}
hist(MeanSalesPerStore,100)
summary(MeanSalesPerStore)
```
Average sales mostly range from 2500 - 7500
Sales vary from stores to stores --> Strong predictor value

Sales in relation to DayOfWeek
```{r}
ggplot(train_store, aes(x=Date,y=Sales,color=DayOfWeek)) + geom_smooth()
```

Day 7 is extremely low compared to other dates --> Strong predictor value
We will look closer at Day 7.

```{r}
train$DayOfWeek <- as.integer(as.factor(train$DayOfWeek))
Day7Sales <- subset(train_store,DayOfWeek==7)
summary(Day7Sales) 
```
Many stores have 0 sales on Sunday, and 97.5% (141137/144730) of the records are closed.

```{r}
summary(subset(Day7Sales,Open==1))
```
All open stores had sales

```{r}
sqldf("select Sales, sum(StateHoliday), sum(SchoolHoliday) from Day7Sales where Sales==0 group by Sales")
```
On State Holiday that fell on Sunday, most stores saw no sales. All Sundays with School Holiday had sales.

Sales in relation to Date
```{r}
ggplot(train_store, aes(x=Date,y=Sales)) + geom_smooth() 
```

Sales increased from 2013 to 2015
```{r}
meansalespercust_bydate <- sqldf("select Date, sum(Sales)/Customers as Average from train_store where Sales>0 group by Date")
ggplot(meansalespercust_bydate, aes(x=Date, y=Average))+ geom_smooth() + ggtitle("Sales per Customer")
```

As sales and customers increase, the store gained more sales per customer.

Sales in relation to Customers
```{r}
ggplot(train_store, aes(x=Date,y=Customers)) + geom_smooth() 
```

Customers increased from 2013 to 2015
```{r}
MeanSalePerCust <- vector(mode = "numeric",length = 7)
for (i in 1:7) {
  MeanSalePerCust [i] <- mean(train_store$Customers[train_store$DayOfWeek==i])
}
barplot(MeanSalePerCust ,main="Total customers by Day of Week",names.arg = dput(1:7))
```

Day 1 had the most customers

Sales ~ StateHoliday
```{r}
OpenOnHoliday <- subset(train_store,StateHoliday != 0 & Open==1)
NotOpenOnHoliday <- subset(train_store,StateHoliday != 0 & Open==0)
nrow(OpenOnHoliday) 
nrow(NotOpenOnHoliday) #--> 910/31050 records open on holidays
a1 <- sum(OpenOnHoliday$Sales[OpenOnHoliday$StateHoliday=="a"])
b1 <- sum(OpenOnHoliday$Sales[OpenOnHoliday$StateHoliday=="b"])
c1 <- sum(OpenOnHoliday$Sales[OpenOnHoliday$StateHoliday=="c"])
barplot(c(a1,b1,c1),main="Total sales on each holiday",names.arg = c("a","b","c"))
```
Within 910 stores that are open on holiday, public holiday (a) saw the highest sale (5890305), significantly more than Easter (b) (1433744) and Christmas (c) (691806)

Try to compare sales between dates with holiday and non-holiday --> Ask chi Phuong

Sales ~ SchoolHoliday
```{r}
m <- 0
n <- 0
for (j in 1:1115) {
  sales1 <- mean(train_store$Sales[train_store$Store==j & train_store$SchoolHoliday==1])
  sales2 <- mean(train_store$Sales[train_store$Store==j & train_store$SchoolHoliday==0])
  if (sales2-sales1 > 0) { m = m + 1 }
  else if (sales2-sales1 < 0) { n = n + 1 }
}
m
n
```
Sales was significantly lower on school holidays
Strong predictor value

Sales ~ StoreType
```{r}
a2 <- mean(train_store$Sales[train_store$StoreType=="a"])
b2 <- mean(train_store$Sales[train_store$StoreType=="b"])
c2 <- mean(train_store$Sales[train_store$StoreType=="c"])
d2 <- mean(train_store$Sales[train_store$StoreType=="d"])
barplot(c(a2,b2,c2,d2),main="Mean sales of each store type",names.arg = c("a","b","c","d"))
```
Type b has the highest sales

Determine the sales of each PromoInterval
```{r}
boxplot(Sales ~ PromoInterval, data = train_store,
        main = "Sales based on the PromoInterval",
        xlab = "PromoInterval", ylab = "Sales", col = "blue")
```

Take a closer look at the Jan, Apr, Jun, Oct interval
```{r}
summary(train_store[train_store$PromoInterval == "Jan,Apr,Jul,Oct",]$Sales)

sqldf("SELECT PromoInterval, COUNT(PromoInterval) FROM train_store WHERE Sales > 7614 + 1.5 * (7614-3680) GROUP BY PromoInterval")
```
No interval stands out but Jan, Apr, Jun, Oct had the highest mean and number of outliers -> predictor value

Determine the sales of each assortment
```{r}
ggplot(train_store["Sales" != 0], 
       aes(x = as.Date(Date), y = Sales, color = factor(Assortment))) + 
  geom_smooth(size = 2)
```

Average sales per assortment
```{r}
avg_a <- mean(train_store$Sales[train_store$Assortment == "a"])
avg_b <- mean(train_store$Sales[train_store$Assortment == "b"])
avg_c <- mean(train_store$Sales[train_store$Assortment == "c"])
barplot(c(avg_a,avg_b,avg_c), main = "Average sales per assortment", names.arg = c("a","b","c"))
```

Customers per assortment
```{r}
cust_a <- sum(train_store$Customers[train_store$Assortment == "a"])
cust_b <- sum(train_store$Customers[train_store$Assortment == "b"])
cust_c <- sum(train_store$Customers[train_store$Assortment == "c"])
barplot(c(cust_a,cust_b,cust_c), main = "Customers per assortment", names.arg = c("a","b","c"))
```

Assortment b (b>c>a) had the best sales and always had higher sales than the other assortments, even its average sales. Furthermore, the number of customers who bought b are extremely low compare to other assortments'
--> B's sales performance was good.So why the sales performance of a and c are worse? What qualities did b have?

Correlation between Competition Distance and Sales
```{r}
plot(Sales ~ CompetitionDistance, train_store)
```

There is a clear correlation between sales and competition distance. The plot indicates that the closer the competitor, the lower the sales.

Days since start of promo2
Need to fix and try to find a way to leverage the data

PromoContinuation vs Sales
```{r}
boxplot(Sales ~ PromoContinuation, data = train_store,
        main = "Sales based on the PromoContinuation",
        xlab = "PromoContinuation", ylab = "Sales", col = "yellow")
```

Sales when having a 2nd Promo were less than without a 2nd Promo but not significant
Consider the promo data on Open days
```{r}
row_to_keep = which(train_store$Open > 0)
openday <- train_store[row_to_keep,]
summary(openday)
```
The numbers of PromoContinuation are nearly equal

Sales between promo day and not promo day
```{r}
ggplot(openday["Sales" != 0], 
       aes(x = as.Date(Date), y = Sales, color = factor(Promo))) + 
  geom_smooth(size = 2) + xlab("Date")
promoY <- mean(train_store$Sales[train_store$Promo == 1])
promoN <- mean(train_store$Sales[train_store$Promo == 0])
```

```{r}
barplot(c(promoY,promoN), main = "Average sales per Promo", names.arg = c("1","0"))
```

Sales nearly doubled when there was a promo on that day
