---
title: "Rossmann_2"
author: "Ngoc Ngo & Nhi Huynh"
date: "7/14/2020"
output: html_document
---
DATA CLEANSING

Load packages
```{r}
library(ggplot2)
library(sqldf)
library(dplyr)
```

Import train data
```{r}
train <- read.csv("train.csv")
```

Show the structure of train data
```{r}
str(train)
```
Some data fields should be converted to a more suitable data type for the convenience of the explanatory process.
         
Change the data type of "Date" from "char" to "date"
```{r}
train$Date <- as.Date(as.character(train$Date))
```

Factorize categorical data fields in train data
```{r}
train$DayOfWeek <- as.factor(as.integer(train$DayOfWeek))
train$StateHoliday <- as.factor(as.character(train$StateHoliday))
train$Open <- as.factor(as.character(train$Open))
train$Promo <- as.factor(as.character(train$Promo))
train$SchoolHoliday <- as.factor(as.character(train$SchoolHoliday))
```

Check if there's any NA to deal with
```{r}
table (complete.cases (train))
```
no NULL values found

```{r}
summary(train)
```
Now the train data is ready for the analysis process. We will move to cleaning the store data.
  
Assign column names for store data
```{r}
colNames <- c ("Store", "StoreType",	"Assortment",	"CompetitionDistance",	
              "CompetitionOpenSinceMonth", "CompetitionOpenSinceYear",
              "PromoContinuation",	"PromoParticipationSinceWeek",	
              "PromoParticipationSinceYear", "PromoInterval")
```

Import store data
```{r}
store <- read.table ("store.csv", header = TRUE, sep = ",",
                       strip.white = TRUE, col.names = colNames,
                       na.strings = "?", stringsAsFactors = TRUE)
```

Show the structure of the store data
```{r}
str (store)
```

Identify NA cases
```{r}
table (complete.cases (store))
```
Take a look at the table summary to identify the NAs
```{r}
summary(store)
```
Replace the NAs in Competition Distance by its median
```{r}
store$CompetitionDistance[is.na(store$CompetitionDistance)] <- median(store$CompetitionDistance, na.rm=TRUE)
```

Replace the remaining NA's by 0
```{r}
store[is.na(store)] <- 0
```
EXPLORATION

Join train and store tables to further explore other correlations between the data fields of 2 tables
```{r}
train_store <- merge(train, store, by = "Store")
```

For graph to show full number
```{r}
options("scipen" = 10)
```

Sales in relation to Store
```{r}
MeanSalesPerStore <- vector(mode = "numeric",length = 1115)
for (i in 1:1115) {
  MeanSalesPerStore[i] <- mean(train_store$Sales[train_store$Store==i])
}
match(max(MeanSalesPerStore),MeanSalesPerStore) 
match(min(MeanSalesPerStore),MeanSalesPerStore) 
```
Store 262 has the max mean sales
Store 307 has the min mean sales

```{r}
hist(MeanSalesPerStore,100)
summary(MeanSalesPerStore)
```
Average sales mostly range from 2500 - 7500
Outliers: Store with over 10000 in mean sales
Sales vary from stores to stores --> Strong predictor value

Sales in relation to DayOfWeek
```{r}
boxplot(Sales ~ DayOfWeek,data=train_store)
```

Day 7 is extremely low compared to other dates
We will look closer at Day 7.

```{r}
Day7Sales <- subset(train_store,DayOfWeek==7)
summary(Day7Sales) 
```
Many stores have 0 sales on Sunday, and 97.5% (141137/144730) of the records are closed.

```{r}
summary(subset(Day7Sales,Open==1))
```
All open stores had sales

```{r}
sqldf("select Sales, sum(StateHoliday), sum(SchoolHoliday) from Day7Sales where Sales==0 group by Sales")
```
On State Holiday that fell on Sunday, no stores had sales. School Holidays that fell on Sunday had sales.

Sales in relation to Date
```{r}
ggplot(train_store, aes(x=Date,y=Sales)) + geom_smooth() 
```

Sales increased from 2013 to 2015
```{r}
meansalespercust_bydate <- sqldf("select Date, sum(Sales)/Customers as Average from train_store where Sales>0 group by Date")
ggplot(meansalespercust_bydate, aes(x=Date, y=Average))+ geom_smooth() + ggtitle("Sales per Customer")
```

As sales and customers increase, the store gained more sales per customer.

Sales in relation to Customers
```{r}
ggplot(train_store, aes(x=Date,y=Customers)) + geom_smooth() 
```

Customers increased from 2013 to 2015

Day 1 of the week (Monday) had the most customers

Sales in relation to StateHoliday
```{r}
OpenOnHoliday <- subset(train_store,StateHoliday != 0 & Open==1)
NotOpenOnHoliday <- subset(train_store,StateHoliday != 0 & Open==0)
nrow(OpenOnHoliday) 
nrow(NotOpenOnHoliday) #--> 910/31050 records open on holidays
sum_a <- sum(OpenOnHoliday$Sales[OpenOnHoliday$StateHoliday=="a"])
sum_b <- sum(OpenOnHoliday$Sales[OpenOnHoliday$StateHoliday=="b"])
sum_c <- sum(OpenOnHoliday$Sales[OpenOnHoliday$StateHoliday=="c"])
barplot(c(sum_a,sum_b,sum_c),main="Total sales on each holiday",names.arg = c("a","b","c"))
```

Within 910 stores that are open on holiday, public holiday (a) saw the highest sale (5890305 - sum_a), significantly more than Easter (b) (1433744- sum_b) and Christmas (c) (691806- sum_c)

Try to compare sales between dates with holiday and non-holiday --> Ask chi Phuong

Sales in relation to SchoolHoliday
```{r}
SaleonHoliday <- 0
SaleNotOnHoliday <- 0
for (j in 1:1115) {
  sales1 <- mean(train_store$Sales[train_store$Store==j & train_store$SchoolHoliday==1])
  sales2 <- mean(train_store$Sales[train_store$Store==j & train_store$SchoolHoliday==0])
  if (sales2-sales1 > 0) { SaleonHoliday = SaleonHoliday + 1 }
  else if (sales2-sales1 < 0) { SaleNotOnHoliday = SaleNotOnHoliday + 1 }
}
SaleonHoliday
SaleNotOnHoliday
```
Sales was significantly lower on school holidays
--> Strong predictor value

Sales in relation to StoreType
```{r}
boxplot(Sales ~ StoreType,data=train_store)
```
Type b has the highest mean sales

Determine the sales of each PromoInterval
```{r}
boxplot(Sales ~ PromoInterval, data = train_store,
        main = "Sales based on the PromoInterval",
        xlab = "PromoInterval", ylab = "Sales", col = "blue")
```

Overall, all intervals share relatively same mean, quartiles, and minimum and maximum values. However, The "Jan, Apr, Jun, Oct" interval had the highest mean and number of outliers.
Take a closer look at the "Jan, Apr, Jun, Oct" interval
```{r}
summary(train_store[train_store$PromoInterval == "Jan,Apr,Jul,Oct",]$Sales)

sqldf("SELECT PromoInterval, COUNT(PromoInterval) FROM train_store WHERE Sales > 7614 + 1.5 * (7614-3680) GROUP BY PromoInterval")
```
The "Jan, Apr, Jun, Oct" interval's number of outliers are more than 5 times bigger than those of other intervals

Distribution of each assortment
```{r}
boxplot(Sales ~ Assortment,data=train_store)
```
We can see that assortment b had the best sales among three assortments  

Determine the sales of each assortment in the timeline
```{r}
ggplot(train_store["Sales" != 0], 
       aes(x = as.Date(Date), y = Sales, color = factor(Assortment))) + 
  geom_smooth(size = 2)
```
Assortment b (b>c>a) always had higher sales than the other assortments

Let's see if the Average sales per assortment of b assortment would be the same
```{r}
avg_a <- mean(train_store$Sales[train_store$Assortment == "a"])
avg_b <- mean(train_store$Sales[train_store$Assortment == "b"])
avg_c <- mean(train_store$Sales[train_store$Assortment == "c"])
barplot(c(avg_a,avg_b,avg_c), main = "Average sales per assortment", names.arg = c("a","b","c"))
```
Yes, even its average sales is higher than the others' average sales

Customers per assortment
```{r}
cust_a <- sum(train_store$Customers[train_store$Assortment == "a"])
cust_b <- sum(train_store$Customers[train_store$Assortment == "b"])
cust_c <- sum(train_store$Customers[train_store$Assortment == "c"])
barplot(c(cust_a,cust_b,cust_c), main = "Customers per assortment", names.arg = c("a","b","c"))
```
Furthermore, the number of customers who bought b are extremely low compare to other assortments'
--> B's sales performance was far better thanthose of the other two.

Move on to the correlation between Competition Distance and Sales
```{r}
plot(Sales ~ CompetitionDistance, train_store)
```

There is a clear correlation between sales and competition distance. The plot indicates that the closer the competitor, the lower the sales.

Days since start of promo2
! Need to find a way to leverage the data promo2 !

PromoContinuation vs Sales
```{r}
boxplot(Sales ~ PromoContinuation, data = train_store,
        main = "Sales based on the PromoContinuation",
        xlab = "PromoContinuation", ylab = "Sales", col = "yellow")
```

Sales when having a 2nd Promo were less than without a 2nd Promo but not significant

Since there is 0 sales on closed days. I want to specifically look at the promo data on Open days
```{r}
row_to_keep = which(as.integer(train_store$Open) > 0)
openday <- train_store[row_to_keep,]
summary(openday)
```
The number of two categories of PromoContinuation are nearly equal, which is good for the comparison of sales between the two.

We compare sales between promo day and not promo day
```{r}
ggplot(openday["Sales" != 0], 
       aes(x = as.Date(Date), y = Sales, color = factor(Promo))) + 
  geom_smooth(size = 2) + xlab("Date")
promoY <- mean(train_store$Sales[train_store$Promo == 1])
promoN <- mean(train_store$Sales[train_store$Promo == 0])
```

```{r}
barplot(c(promoY,promoN), main = "Average sales per Promo", names.arg = c("1","0"))
```

Sales nearly doubled when there was a promo on that day.
