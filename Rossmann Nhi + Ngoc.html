---
title: "Rossmann_Cleaning&Exploration"
author: "Ngoc Ngo & Nhi Huynh"
date: "7/15/2020"
output: html_document
---
DATA CLEANSING

Load packages
```{r}
library(ggplot2)
library(sqldf)
library(dplyr)
library(reshape2)
```

Import train data
```{r}
train <- read.csv("train.csv")
```

Show the structure of train data
```{r}
str(train)
```

Some data fields should be converted to a more suitable data type for the convenience of the explanatory process.

```{r}
str(train$Date)
```

Change the data type of "Date" from "char" to "date"
```{r}
train$Date <- as.Date(train$Date,format = "%m/%d/%y")
```

Factorize categorical data fields in train data
```{r}
train$DayOfWeek <- as.factor(as.integer(train$DayOfWeek))
train$StateHoliday <- as.factor(as.character(train$StateHoliday))
train$Open <- as.factor(as.character(train$Open))
train$Promo <- as.factor(as.character(train$Promo))
train$SchoolHoliday <- as.factor(as.character(train$SchoolHoliday))
```

Check the data modification and identify NA cases in the test table
```{r}
summary(train)
```
No NULL values found. Now the train data is ready for the analysis process. We will move to cleaning the store data.
  
Assign column names for store data
```{r}
colNames <- c ("Store", "StoreType",	"Assortment",	"CompetitionDistance",	
              "CompetitionOpenSinceMonth", "CompetitionOpenSinceYear",
              "PromoContinuation",	"PromoParticipationSinceWeek",	
              "PromoParticipationSinceYear", "PromoInterval")
```

Import store data
```{r}
store <- read.table ("store.csv", header = TRUE, sep = ",",
                       strip.white = TRUE, col.names = colNames,
                       na.strings = "?", stringsAsFactors = TRUE)
```

Show the structure of the store data
```{r}
str (store)
```

Identify NA cases
```{r}
table (complete.cases (store))
```

Take a look at the table summary to identify the NAs
```{r}
summary(store)
```

Replace the NAs in Competition Distance by its median
```{r}
store$CompetitionDistance[is.na(store$CompetitionDistance)] <- median(store$CompetitionDistance, na.rm=TRUE)
```

Replace the remaining NA's by 0
```{r}
store[is.na(store)] <- 0
```

EXPLORATION

Join train and store tables to further explore other correlations between the data fields of 2 tables.
```{r}
train_store <- merge(train, store, by = "Store")
```

For graph to display number in full (E.g. 1000000 instead of 10e6)
```{r}
options("scipen" = 10)
```

For our exploratory data analysis, we will look into the relationship between Sales
and other data fields.

Sales vs Store

Here we made a vector containing the mean sales of 1115 stores
```{r}
MeanSalesPerStore <- vector(mode = "numeric",length = 1115)
for (i in 1:1115) {
  MeanSalesPerStore[i] <- mean(train_store$Sales[train_store$Store==i])
}
```

```{r}
hist(MeanSalesPerStore,xlab="Sales (€)")
summary(MeanSalesPerStore)
```
Sales vary from stores to stores.
The outliers are stores with over €20719 in mean sales.

Sales vs DayOfWeek
```{r}
boxplot(Sales ~ DayOfWeek,data=train_store)
```

Sales of day 7 of the week (Sunday) is extremely low compared to other dates.

We will take a closer look at Day 7.
```{r}
Day7Sales <- subset(train_store,DayOfWeek==7)
summary(Day7Sales) 
```
Look at "Sales" data, we see that most stores have 0 sales on Sunday, and this is because 97.5% (141137/144730) of the records indicated that the stores were closed on those dates.

Now we will check if the stores that were open on Day 7 had sales or not.
```{r}
summary(subset(Day7Sales,Open==1,select=c(Sales)))
```
All stores that were opened on Day 7 had sales.

```{r}
boxplot(Sales ~ DayOfWeek,data=train_store[train_store$Sales!=0,])
```
Sales of stores that were opened on Sunday are higher than weekdays.
We will use this insight to check whether other factors affect the high sales.

Holiday might be a factor of store closure, so we will check that as follow:
```{r}
sqldf("select Open, sum(StateHoliday), sum(SchoolHoliday) from Day7Sales group by Open")
```
On all Day 7 records, no stores open on State Holiday. 2642 records that was on School Holiday indicated that the store was closed, while in total we have 141137 closed stores. 
Therefore, holidays are not a strong factor of store closure like we assumed.

Sales vs Date
```{r}
nrow(unique(train["Date"]))
```
There's 942 different dates in the train table.

```{r}
ggplot(train_store, aes(x=Date,y=Sales)) + geom_smooth() 
```

Sales increased from 2013 to 2015, with fluctuations. Sales tend to decrease mid-year and then took off again at the end of the year.

Sales vs Customers
```{r}
ggplot(train_store, aes(x=Date,y=Customers)) + geom_smooth() 
```

Customers increased from 2013 to 2015.

We can see that the Customers' graph shows a similar trend as Sales. We will check for correlation between Sales and Customers.
```{r}
Linear <- lm(Sales ~ Customers, data=train_store)
summary(Linear)
```

Customers and Sales are strongly correlated (Adjusted R-squared:  0.8005)

Sales vs StateHoliday
```{r}
boxplot(Sales ~ StateHoliday,data=train_store)
```

Sales are significantly lower on holidays.
--> Strong predictor value.

Now we want to see which holidays had the most sales.
```{r}
OpenOnHoliday <- subset(train_store,Open==1)
mean(OpenOnHoliday$Sales[OpenOnHoliday$StateHoliday=="a"])
mean(OpenOnHoliday$Sales[OpenOnHoliday$StateHoliday=="b"])
mean(OpenOnHoliday$Sales[OpenOnHoliday$StateHoliday=="c"])
```

Within 910 stores that are open on holiday, Easter (b) saw the highest sale (9887.89), slightly higher than Christmas (c) (9743.746) and significantly higher than public holidays (a) (8487.471).

Sales vs SchoolHoliday
```{r}
boxplot(Sales ~ SchoolHoliday,data=train_store)
```

Sales on School Holiday were just slightly higher than that of non-School Holiday. Therefore, School Holiday is not a strong predictor value.

Sales vs StoreType
```{r}
boxplot(Sales ~ StoreType,data=train_store)
```

Type b has the highest mean sales.

Determine the sales of each PromoInterval
```{r}
boxplot(Sales ~ PromoInterval, data = train_store,
        main = "Sales based on the PromoInterval",
        xlab = "PromoInterval", ylab = "Sales", col = "blue")
```

Overall, all intervals share relatively same mean, quartiles, and minimum and maximum values. However, The "Jan, Apr, Jun, Oct" interval had the highest mean and number of outliers.

Take a closer look at the "Jan, Apr, Jun, Oct" interval
```{r}
summary(train_store[train_store$PromoInterval == "Jan,Apr,Jul,Oct",]$Sales)

sqldf("SELECT PromoInterval, COUNT(PromoInterval) FROM train_store WHERE Sales > 7614 + 1.5 * (7614-3680) GROUP BY PromoInterval")
```
The "Jan, Apr, Jun, Oct" interval's number of outliers are more than 5 times bigger than those of other intervals.

Distribution of each assortment
```{r}
boxplot(Sales ~ Assortment,data=train_store)
```

We can see that assortment b had the best sales among three assortments.  

Determine the sales of each assortment in the timeline
```{r}
ggplot(train_store["Sales" != 0], 
       aes(x = as.Date(Date), y = Sales, color = factor(Assortment))) + 
  geom_smooth(size = 2)
```

Assortment b (b>c>a) always had higher sales than the other assortments.

Let's see if the Average sales per assortment of b assortment would be the same
```{r}
avg_a <- mean(train_store$Sales[train_store$Assortment == "a"])
avg_b <- mean(train_store$Sales[train_store$Assortment == "b"])
avg_c <- mean(train_store$Sales[train_store$Assortment == "c"])
barplot(c(avg_a,avg_b,avg_c), main = "Average sales per assortment", names.arg = c("a","b","c"))
```

Yes, even its average sales is higher than the others' average sales.

Customers per assortment
```{r}
cust_a <- sum(train_store$Customers[train_store$Assortment == "a"])
cust_b <- sum(train_store$Customers[train_store$Assortment == "b"])
cust_c <- sum(train_store$Customers[train_store$Assortment == "c"])
barplot(c(cust_a,cust_b,cust_c), main = "Customers per assortment", names.arg = c("a","b","c"))
```

Furthermore, the number of customers who bought b are extremely low compare to other assortments'
--> B's sales performance was far better thanthose of the other two.

Move on to the correlation between Competition Distance and Sales
```{r}
plot(Sales ~ CompetitionDistance, train_store)
```

There is a clear correlation between sales and competition distance. The plot indicates that the closer the competitor, the lower the sales.

Days since start of promo2

!! Need to find a way to leverage the data promo2 !!

PromoContinuation vs Sales
```{r}
boxplot(Sales ~ PromoContinuation, data = train_store,
        main = "Sales based on the PromoContinuation",
        xlab = "PromoContinuation", ylab = "Sales", col = "yellow")
```

Sales when having a 2nd Promo were less than without a 2nd Promo but not significant

Since there is 0 sales on closed days, I want to specifically look at the promo data on Open days
```{r}
row_to_keep = which(as.integer(train_store$Open) > 0)
openday <- train_store[row_to_keep,]
summary(openday)
```
The number of two categories of PromoContinuation are nearly equal, which is good for the comparison of sales between the two.

We compare sales between promo day and not promo day
```{r}
ggplot(openday["Sales" != 0], 
       aes(x = as.Date(Date), y = Sales, color = factor(Promo))) + 
  geom_smooth(size = 2) + xlab("Date")
promoY <- mean(train_store$Sales[train_store$Promo == 1])
promoN <- mean(train_store$Sales[train_store$Promo == 0])
```

```{r}
barplot(c(promoY,promoN), main = "Average sales per Promo", names.arg = c("1","0"))
```

Sales nearly doubled when there was a promo on that day.
